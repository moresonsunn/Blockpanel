# All-in-one single image using controller-unified.Dockerfile (includes Java runtimes)
# Build & run:
#   docker compose -f docker-compose.unified.yml up -d --build

services:
  blockpanel:
    image: moresonsun/blockpanel-unified:latest
    build:
      context: .
      dockerfile: docker/controller-unified.Dockerfile
      args:
        - APP_VERSION=${BLOCKPANEL_TAG:-dev}
    ports:
      - "8000:8000"
    environment:
      - APP_NAME=BlockPanel
      - APP_VERSION=latest
      - USE_POSTGRES=false
      - DATABASE_URL=sqlite:////data/sqlite/minecraft_controller.db
      - SERVERS_CONTAINER_ROOT=/data/servers
      # Must match the actual Docker named volume created by compose: <project>_servers_data
      - SERVERS_VOLUME_NAME=minecraft-controller_servers_data
      - BLOCKPANEL_RUNTIME_IMAGE=moresonsun/blockpanel-unified
      - BLOCKPANEL_RUNTIME_TAG=latest
      - DOCKER_HOST=unix:///var/run/docker.sock
      - ENVIRONMENT=production
      - SECRET_KEY=${SECRET_KEY:-change-me-single-container-secret}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ADMIN_PASSWORD=YourNewStrongPass123!
      # Explicit origins required for credentialed requests (Authorization header)
      - ALLOWED_ORIGINS="http://localhost:8000,http://127.0.0.1:8000,http://192.168.2.190:8000,http://localhost:5173,http://127.0.0.1:5173,http://localhost:3000,http://127.0.0.1:3000"
      # Temporary debug endpoint enabling /debug/echo-headers (remove or set 0 in production)
      - ENABLE_DEBUG_ENDPOINTS=1
    volumes:
      - servers_data:/data/servers
      - sqlite_data:/data/sqlite
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/quick"]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  servers_data:
  sqlite_data:
