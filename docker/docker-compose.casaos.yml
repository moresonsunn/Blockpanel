# CasaOS-ready compose for BlockPanel (Unified)
# Minimal ports, proper volumes, CasaOS labels, and environment for dynamic runtime containers.

services:
  blockpanel:
    image: moresonsun/blockpanel-unified:casaos-fix
    container_name: blockpanel
    networks:
      - blockpanel_net
    ports:
      - "8000:8000"
      # Explicitly publish Minecraft ports (no range syntax for CasaOS)
      # TCP and UDP for 25565-25665; extend similarly if you need more servers
      - "25565:25565/tcp"
      - "25565:25565/udp"
      - "25566:25566/tcp"
      - "25566:25566/udp"
      - "25567:25567/tcp"
      - "25567:25567/udp"
      - "25568:25568/tcp"
      - "25568:25568/udp"
      - "25569:25569/tcp"
      - "25569:25569/udp"
      - "25570:25570/tcp"
      - "25570:25570/udp"
      - "25571:25571/tcp"
      - "25571:25571/udp"
      - "25572:25572/tcp"
      - "25572:25572/udp"
      - "25573:25573/tcp"
      - "25573:25573/udp"
      - "25574:25574/tcp"
      - "25574:25574/udp"
      - "25575:25575/tcp"
      - "25575:25575/udp"
      - "25576:25576/tcp"
      - "25576:25576/udp"
      - "25577:25577/tcp"
      - "25577:25577/udp"
      - "25578:25578/tcp"
      - "25578:25578/udp"
      - "25579:25579/tcp"
      - "25579:25579/udp"
      - "25580:25580/tcp"
      - "25580:25580/udp"
      - "25581:25581/tcp"
      - "25581:25581/udp"
      - "25582:25582/tcp"
      - "25582:25582/udp"
      - "25583:25583/tcp"
      - "25583:25583/udp"
      - "25584:25584/tcp"
      - "25584:25584/udp"
      - "25585:25585/tcp"
      - "25585:25585/udp"
      - "25586:25586/tcp"
      - "25586:25586/udp"
      - "25587:25587/tcp"
      - "25587:25587/udp"
      - "25588:25588/tcp"
      - "25588:25588/udp"
      - "25589:25589/tcp"
      - "25589:25589/udp"
      - "25590:25590/tcp"
      - "25590:25590/udp"
      - "25591:25591/tcp"
      - "25591:25591/udp"
      - "25592:25592/tcp"
      - "25592:25592/udp"
      - "25593:25593/tcp"
      - "25593:25593/udp"
      - "25594:25594/tcp"
      - "25594:25594/udp"
      - "25595:25595/tcp"
      - "25595:25595/udp"
      - "25596:25596/tcp"
      - "25596:25596/udp"
      - "25597:25597/tcp"
      - "25597:25597/udp"
      - "25598:25598/tcp"
      - "25598:25598/udp"
      - "25599:25599/tcp"
      - "25599:25599/udp"
      - "25600:25600/tcp"
      - "25600:25600/udp"
      - "25601:25601/tcp"
      - "25601:25601/udp"
      - "25602:25602/tcp"
      - "25602:25602/udp"
      - "25603:25603/tcp"
      - "25603:25603/udp"
      - "25604:25604/tcp"
      - "25604:25604/udp"
      - "25605:25605/tcp"
      - "25605:25605/udp"
      - "25606:25606/tcp"
      - "25606:25606/udp"
      - "25607:25607/tcp"
      - "25607:25607/udp"
      - "25608:25608/tcp"
      - "25608:25608/udp"
      - "25609:25609/tcp"
      - "25609:25609/udp"
      - "25610:25610/tcp"
      - "25610:25610/udp"
      - "25611:25611/tcp"
      - "25611:25611/udp"
      - "25612:25612/tcp"
      - "25612:25612/udp"
      - "25613:25613/tcp"
      - "25613:25613/udp"
      - "25614:25614/tcp"
      - "25614:25614/udp"
      - "25615:25615/tcp"
      - "25615:25615/udp"
      - "25616:25616/tcp"
      - "25616:25616/udp"
      - "25617:25617/tcp"
      - "25617:25617/udp"
      - "25618:25618/tcp"
      - "25618:25618/udp"
      - "25619:25619/tcp"
      - "25619:25619/udp"
      - "25620:25620/tcp"
      - "25620:25620/udp"
      - "25621:25621/tcp"
      - "25621:25621/udp"
      - "25622:25622/tcp"
      - "25622:25622/udp"
      - "25623:25623/tcp"
      - "25623:25623/udp"
      - "25624:25624/tcp"
      - "25624:25624/udp"
      - "25625:25625/tcp"
      - "25625:25625/udp"
      - "25626:25626/tcp"
      - "25626:25626/udp"
      - "25627:25627/tcp"
      - "25627:25627/udp"
      - "25628:25628/tcp"
      - "25628:25628/udp"
      - "25629:25629/tcp"
      - "25629:25629/udp"
      - "25630:25630/tcp"
      - "25630:25630/udp"
      - "25631:25631/tcp"
      - "25631:25631/udp"
      - "25632:25632/tcp"
      - "25632:25632/udp"
      - "25633:25633/tcp"
      - "25633:25633/udp"
      - "25634:25634/tcp"
      - "25634:25634/udp"
      - "25635:25635/tcp"
      - "25635:25635/udp"
      - "25636:25636/tcp"
      - "25636:25636/udp"
      - "25637:25637/tcp"
      - "25637:25637/udp"
      - "25638:25638/tcp"
      - "25638:25638/udp"
      - "25639:25639/tcp"
      - "25639:25639/udp"
      - "25640:25640/tcp"
      - "25640:25640/udp"
      - "25641:25641/tcp"
      - "25641:25641/udp"
      - "25642:25642/tcp"
      - "25642:25642/udp"
      - "25643:25643/tcp"
      - "25643:25643/udp"
      - "25644:25644/tcp"
      - "25644:25644/udp"
      - "25645:25645/tcp"
      - "25645:25645/udp"
      - "25646:25646/tcp"
      - "25646:25646/udp"
      - "25647:25647/tcp"
      - "25647:25647/udp"
      - "25648:25648/tcp"
      - "25648:25648/udp"
      - "25649:25649/tcp"
      - "25649:25649/udp"
      - "25650:25650/tcp"
      - "25650:25650/udp"
      - "25651:25651/tcp"
      - "25651:25651/udp"
      - "25652:25652/tcp"
      - "25652:25652/udp"
      - "25653:25653/tcp"
      - "25653:25653/udp"
      - "25654:25654/tcp"
      - "25654:25654/udp"
      - "25655:25655/tcp"
      - "25655:25655/udp"
      - "25656:25656/tcp"
      - "25656:25656/udp"
      - "25657:25657/tcp"
      - "25657:25657/udp"
      - "25658:25658/tcp"
      - "25658:25658/udp"
      - "25659:25659/tcp"
      - "25659:25659/udp"
      - "25660:25660/tcp"
      - "25660:25660/udp"
      - "25661:25661/tcp"
      - "25661:25661/udp"
      - "25662:25662/tcp"
      - "25662:25662/udp"
      - "25663:25663/tcp"
      - "25663:25663/udp"
      - "25664:25664/tcp"
      - "25664:25664/udp"
      - "25665:25665/tcp"
      - "25665:25665/udp"
    environment:
      APP_NAME: BlockPanel
      APP_VERSION: latest
      RUNTIME_MODE: local
      USE_POSTGRES: "false"
      DATABASE_URL: sqlite:////data/sqlite/minecraft_controller.db
      SERVERS_CONTAINER_ROOT: /data/servers
      SERVERS_VOLUME_NAME: blockpanel_servers
      BLOCKPANEL_RUNTIME_IMAGE: moresonsun/blockpanel-unified
      BLOCKPANEL_RUNTIME_TAG: latest
      DOCKER_HOST: unix:///var/run/docker.sock
      ENVIRONMENT: production
      SECRET_KEY: ${SECRET_KEY:-change-me-unified-secret}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # CORS: allow CasaOS and local LAN by regex; tighten in production if desired
      ALLOWED_ORIGIN_REGEX: ".*"
      # Associate runtime containers to avoid legacy-app grouping in CasaOS UI
      CASAOS_APP_ID: blockpanel-unified
      # Compose context so runtime (if docker mode is used) can join same group
      CASAOS_COMPOSE_PROJECT: blockpanel-unified
      # Ensure runtime containers join the same network as the controller
      COMPOSE_NETWORK: blockpanel_net
    volumes:
      - blockpanel_servers:/data/servers
      - blockpanel_sqlite:/data/sqlite
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/quick"]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      io.casaos.app: "blockpanel-unified"
      io.casaos.managed: "true"
      io.casaos.category: "Game Servers"
      com.docker.compose.project: "blockpanel-unified"
      com.docker.compose.service: "controller"
      com.docker.compose.version: "2"

volumes:
  blockpanel_servers:
    name: blockpanel_servers
  blockpanel_sqlite:
    name: blockpanel_sqlite

networks:
  blockpanel_net:
    name: blockpanel_net
    driver: bridge
