# CasaOS-ready compose for Lynx (Unified)
# Minimal ports, proper volumes, CasaOS labels, and environment for dynamic runtime containers.

services:
  lynx:
    image: moresonsun/lynx:latest
    container_name: lynx
    networks:
      - lynx_net
    ports:
      - "8000:8000"
      # Explicitly publish Minecraft ports (no range syntax for CasaOS)
      # TCP and UDP for 25565-25580; extend similarly if you need more servers
      - "25565:25565/tcp"
      - "25566:25566/tcp"
      - "25567:25567/tcp"
      - "25568:25568/tcp"
      - "25569:25569/tcp"
      - "25570:25570/tcp"
      - "25571:25571/tcp"
      - "25572:25572/tcp"
      - "25573:25573/tcp"
      - "25574:25574/tcp"
      - "25575:25575/tcp"
      - "25576:25576/tcp"
      - "25577:25577/tcp"
      - "25578:25578/tcp"
      - "25579:25579/tcp"
      - "25580:25580/tcp"
    environment:
      APP_NAME: Lynx
      APP_VERSION: latest
      RUNTIME_MODE: local
      USE_POSTGRES: "false"
      DATABASE_URL: sqlite:////data/sqlite/minecraft_controller.db
      SERVERS_CONTAINER_ROOT: /data/servers
      SERVERS_VOLUME_NAME: lynx_servers
      LYNX_RUNTIME_IMAGE: moresonsun/lynx
      LYNX_RUNTIME_TAG: latest
      DOCKER_HOST: unix:///var/run/docker.sock
      ENVIRONMENT: production
      SECRET_KEY: ${SECRET_KEY:-change-me-unified-secret}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # CORS: allow CasaOS and local LAN by regex; tighten in production if desired
      ALLOWED_ORIGIN_REGEX: ".*"
      # Associate runtime containers to avoid legacy-app grouping in CasaOS UI
      CASAOS_APP_ID: lynx
      # Compose context so runtime (if docker mode is used) can join same group
      CASAOS_COMPOSE_PROJECT: lynx
      # Ensure runtime containers join the same network as the controller
      COMPOSE_NETWORK: lynx_net
      # CasaOS v2 compose apps (Steam servers)
      CASAOS_API_BASE: ${CASAOS_API_BASE:-}
      CASAOS_API_TOKEN: ${CASAOS_API_TOKEN:-}
    volumes:
      - lynx_servers:/data/servers
      - lynx_sqlite:/data/sqlite
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/quick"]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      io.casaos.app: "lynx"
      io.casaos.managed: "true"
      io.casaos.category: "Game Servers"
      com.docker.compose.project: "lynx"
      com.docker.compose.service: "controller"
      com.docker.compose.version: "2"

volumes:
  lynx_servers:
    name: lynx_servers
  lynx_sqlite:
    name: lynx_sqlite

networks:
  lynx_net:
    name: lynx_net
    driver: bridge
