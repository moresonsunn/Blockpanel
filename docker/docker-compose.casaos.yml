# CasaOS-ready compose for BlockPanel (Unified)
# Minimal ports, proper volumes, CasaOS labels, and environment for dynamic runtime containers.

services:
  blockpanel:
    image: moresonsun/blockpanel-unified:casaos-fix
    container_name: blockpanel
    networks:
      - blockpanel_net
    ports:
      - "8000:8000"
      # Explicitly publish Minecraft ports (no range syntax for CasaOS)
      # TCP and UDP for 25565-25665; extend similarly if you need more servers
      - "25565:25565/tcp+udp"
      - "25566:25566/tcp+udp"
      - "25567:25567/tcp+udp"
      - "25568:25568/tcp+udp"
      - "25569:25569/tcp+udp"
      - "25570:25570/tcp+udp"
      - "25571:25571/tcp+udp"
      - "25572:25572/tcp+udp"
      - "25573:25573/tcp+udp"
      - "25574:25574/tcp+udp"
      - "25575:25575/tcp+udp"
      - "25576:25576/tcp+udp"
      - "25577:25577/tcp+udp"
      - "25578:25578/tcp+udp"
      - "25579:25579/tcp+udp"
      - "25580:25580/tcp+udp"
      - "25581:25581/tcp+udp"
      - "25582:25582/tcp+udp"
      - "25583:25583/tcp+udp"
      - "25584:25584/tcp+udp"
      - "25585:25585/tcp+udp"
      - "25586:25586/tcp+udp"
      - "25587:25587/tcp+udp"
      - "25588:25588/tcp+udp"
      - "25589:25589/tcp+udp"
      - "25590:25590/tcp+udp"
      - "25591:25591/tcp+udp"
      - "25592:25592/tcp+udp"
      - "25593:25593/tcp+udp"
      - "25594:25594/tcp+udp"
      - "25595:25595/tcp+udp"
      - "25596:25596/tcp+udp"
      - "25597:25597/tcp+udp"
      - "25598:25598/tcp+udp"
      - "25599:25599/tcp+udp"
      - "25600:25600/tcp+udp"
    environment:
      APP_NAME: BlockPanel
      APP_VERSION: latest
      RUNTIME_MODE: local
      USE_POSTGRES: "false"
      DATABASE_URL: sqlite:////data/sqlite/minecraft_controller.db
      SERVERS_CONTAINER_ROOT: /data/servers
      SERVERS_VOLUME_NAME: blockpanel_servers
      BLOCKPANEL_RUNTIME_IMAGE: moresonsun/blockpanel-unified
      BLOCKPANEL_RUNTIME_TAG: latest
      DOCKER_HOST: unix:///var/run/docker.sock
      ENVIRONMENT: production
      SECRET_KEY: ${SECRET_KEY:-change-me-unified-secret}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # CORS: allow CasaOS and local LAN by regex; tighten in production if desired
      ALLOWED_ORIGIN_REGEX: ".*"
      # Associate runtime containers to avoid legacy-app grouping in CasaOS UI
      CASAOS_APP_ID: blockpanel-unified
      # Compose context so runtime (if docker mode is used) can join same group
      CASAOS_COMPOSE_PROJECT: blockpanel-unified
      # Ensure runtime containers join the same network as the controller
      COMPOSE_NETWORK: blockpanel_net
    volumes:
      - blockpanel_servers:/data/servers
      - blockpanel_sqlite:/data/sqlite
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/quick"]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    labels:
      io.casaos.app: "blockpanel-unified"
      io.casaos.managed: "true"
      io.casaos.category: "Game Servers"
      com.docker.compose.project: "blockpanel-unified"
      com.docker.compose.service: "controller"
      com.docker.compose.version: "2"

volumes:
  blockpanel_servers:
    name: blockpanel_servers
  blockpanel_sqlite:
    name: blockpanel_sqlite

networks:
  blockpanel_net:
    name: blockpanel_net
    driver: bridge
